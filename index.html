<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emoji Buddy Â· Opulent Hardware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Saira:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --shell-main: #4c1d95;
      --shell-dark: #2e1065;
      --shell-light: #7c3aed;
      --accent: #facc15;
      --ring-soft: rgba(148, 163, 184, 0.16);
      --emoji-scale: 1;
      --emoji-offset-x: 0px;
      --emoji-offset-y: 0px;
      --audio-glow: 0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color: #e5e7eb;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .canvas {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    /* SHELL --------------------------------------------------------------- */

    .gb-shell {
      position: relative;
      width: min(420px, 96vw);
      aspect-ratio: 3 / 4;
      border-radius: 30px;
      background:
        radial-gradient(circle at -10% -20%, rgba(255, 255, 255, 0.10), transparent 55%),
        radial-gradient(circle at 110% 120%, rgba(15, 23, 42, 0.65), transparent 60%),
        linear-gradient(135deg, var(--shell-main), var(--shell-dark));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.8),
        0 24px 60px rgba(0, 0, 0, 0.95);
      padding: 14px 14px 18px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      row-gap: 10px;
      position: relative;
    }

    /* color themes */

    .gb-shell[data-color="grape"] {
      --shell-main: #4c1d95;
      --shell-dark: #2e1065;
      --shell-light: #7c3aed;
      --accent: #facc15;
      --ring-soft: rgba(196, 181, 253, 0.35);
    }

    .gb-shell[data-color="teal"] {
      --shell-main: #0f766e;
      --shell-dark: #115e59;
      --shell-light: #2dd4bf;
      --accent: #fbbf24;
      --ring-soft: rgba(45, 212, 191, 0.35);
    }

    .gb-shell[data-color="kiwi"] {
      --shell-main: #15803d;
      --shell-dark: #14532d;
      --shell-light: #4ade80;
      --accent: #facc15;
      --ring-soft: rgba(74, 222, 128, 0.35);
    }

    .gb-shell[data-color="berry"] {
      --shell-main: #9f1239;
      --shell-dark: #881337;
      --shell-light: #fb7185;
      --accent: #fbbf24;
      --ring-soft: rgba(248, 113, 113, 0.35);
    }

    .gb-shell[data-color="smoke"] {
      --shell-main: #374151;
      --shell-dark: #111827;
      --shell-light: #9ca3af;
      --accent: #22c55e;
      --ring-soft: rgba(148, 163, 184, 0.35);
    }

    .gb-shell[data-color="black"] {
      --shell-main: #020617;
      --shell-dark: #000000;
      --shell-light: #4b5563;
      --accent: #facc15;
      --ring-soft: rgba(148, 163, 184, 0.4);
    }

    .gb-shell[data-color="beige"] {
      --shell-main: #d9c9a3;
      --shell-dark: #b7966b;
      --shell-light: #f3e7c8;
      --accent: #22c55e;
      --ring-soft: rgba(150, 120, 80, 0.4);
    }

    .gb-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: conic-gradient(
        from 140deg,
        var(--ring-soft),
        rgba(31, 41, 55, 0.8),
        rgba(15, 23, 42, 0.3),
        var(--ring-soft)
      );
      mix-blend-mode: screen;
      opacity: 0.6;
      pointer-events: none;
    }

    .gb-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: 0 0 42px rgba(15, 23, 42, 0.95) inset;
      pointer-events: none;
    }

    /* TOP BAR ------------------------------------------------------------- */

    .gb-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2px;
      position: relative;
      z-index: 1;
      font-family: "Saira", system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    .gb-brand,
    .gb-top-right {
      font-family: "Saira", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(0,0,0,0.85);
      text-shadow:
        0 0 3px rgba(255,255,255,0.30),
        0 0 6px rgba(0,0,0,0.40);
    }

    .gb-brand {
      font-size: 13px;
      font-weight: 600;
    }

    .gb-top-right {
      font-size: 11px;
      font-weight: 500;
    }

    /* SCREEN -------------------------------------------------------------- */

    .gb-screen-frame {
      border-radius: 18px;
      padding: 8px;
      background:
        linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 10px 20px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .gb-screen {
      flex: 1;
      margin-top: 2px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 50% 0%, rgba(248, 250, 252, 0.08), transparent 60%),
        linear-gradient(180deg, #020617, #020617 60%, #020617);
      box-shadow:
        0 0 0 1px #020617,
        0 0 45px rgba(15, 23, 42, 0.9) inset;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      opacity: 1;
      filter: brightness(1) blur(0);
    }

    .gb-screen::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0%, rgba(248, 250, 252, 0.18), transparent 70%);
      opacity: 0.5;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    /* audio glow overlay */
    .gb-screen::after {
      content: "";
      position: absolute;
      inset: -12%;
      background: radial-gradient(circle at 50% 0%, var(--shell-light), transparent 60%);
      mix-blend-mode: screen;
      opacity: var(--audio-glow);
      pointer-events: none;
      transition: opacity 80ms linear;
    }

    /* MOTION GRAPH -------------------------------------------------------- */

    .motion-graph-shell {
      position: absolute;
      top: 6px;
      left: 8px;
      right: 8px;
      height: 30px;
      z-index: 2;
      pointer-events: none;
    }

    .motion-graph-canvas {
      width: 100%;
      height: 100%;
      display: block;
      opacity: 0;
      transition: opacity 180ms ease-out;
    }

    .motion-graph-canvas.active {
      opacity: 1;
    }

    .emoji-wrap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform: translate3d(var(--emoji-offset-x), var(--emoji-offset-y), 0)
                 scale(var(--emoji-scale));
      transition: transform 80ms linear;
    }

    .emoji {
      position: relative;
      font-size: 180px;
      line-height: 1;
      filter: drop-shadow(0 0 10px rgba(15, 23, 42, 0.9));
      transform-origin: center;
      animation: breathe 6s ease-in-out infinite;
    }

    @keyframes breathe {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }

    .emoji-pop {
      animation: emojiPop 260ms ease-out, breathe 6s ease-in-out 260ms infinite;
    }

    @keyframes emojiPop {
      0%   { transform: scale(0.88); }
      60%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Hard-G stressed bounce */
    .emoji-hard-g {
      animation: hardGBounce 360ms cubic-bezier(.34,1.56,.64,1), breathe 6s ease-in-out 360ms infinite;
    }

    @keyframes hardGBounce {
      0%   { transform: translateY(0) scale(1); }
      30%  { transform: translateY(-8px) scale(1.06); }
      60%  { transform: translateY(4px)  scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }

    /* BOTTOM CONTROLS ----------------------------------------------------- */

    .gb-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .speaker {
      display: grid;
      grid-template-columns: repeat(3, 5px);
      grid-auto-rows: 5px;
      gap: 4px;
      opacity: 0.6;
      filter: drop-shadow(0 1px 0 rgba(15, 23, 42, 0.5));
      cursor: pointer;
    }

    .speaker-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .color-strip {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .color-label {
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .color-swatches {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      box-shadow:
        0 8px 20px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      cursor: pointer;
      padding: 0;
      outline: none;
    }

    .color-swatch[data-color="grape"] { background: linear-gradient(135deg,#7c3aed,#4c1d95); }
    .color-swatch[data-color="teal"]  { background: linear-gradient(135deg,#2dd4bf,#0f766e); }
    .color-swatch[data-color="kiwi"]  { background: linear-gradient(135deg,#4ade80,#15803d); }
    .color-swatch[data-color="berry"] { background: linear-gradient(135deg,#fb7185,#9f1239); }
    .color-swatch[data-color="smoke"] { background: linear-gradient(135deg,#9ca3af,#374151); }
    .color-swatch[data-color="black"] { background: linear-gradient(135deg,#020617,#111827); }
    .color-swatch[data-color="beige"] { background: linear-gradient(135deg,#f3e7c8,#b7966b); }

    .status-strip {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .vibe-label {
      opacity: 0.9;
    }

    .vibe-gauge {
      width: 72px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      background:
        radial-gradient(circle at 0 50%, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 1));
      overflow: hidden;
      position: relative;
    }

    .vibe-fill {
      position: absolute;
      inset: 0;
      transform-origin: left center;
      transform: scaleX(0.5);
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #facc15, #f97316);
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.8);
      transition: transform 120ms ease-out, box-shadow 80ms ease-out;
    }

    /* SIZE DIAL ----------------------------------------------------------- */

    .size-strip {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .size-dial-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .size-dial {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(248, 250, 252, 0.25), transparent 60%),
        linear-gradient(145deg, #111827, #020617);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.95),
        0 3px 6px rgba(0, 0, 0, 0.8);
      position: relative;
      cursor: pointer;
      transition: box-shadow 120ms ease-out, transform 120ms ease-out;
    }

    .size-dial-notch {
      position: absolute;
      top: 2px;
      left: 50%;
      width: 2px;
      height: 8px;
      border-radius: 999px;
      background: #f9fafb;
      transform: translateX(-50%);
      box-shadow: 0 0 4px rgba(248, 250, 252, 0.8);
    }

    .size-dial-label {
      font-size: 8px;
    }

    /* shell wobble */

    .wobble {
      animation: wobble 520ms ease-in-out;
    }

    @keyframes wobble {
      0%   { transform: translateX(0) rotate(0deg); }
      20%  { transform: translateX(-2px) rotate(-0.45deg); }
      40%  { transform: translateX(3px) rotate(0.45deg); }
      65%  { transform: translateX(-1.5px) rotate(-0.25deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }

    /* STARTUP BOOT SEQUENCE ----------------------------------------------- */

    .gb-screen.boot-off {
      opacity: 0;
      filter: brightness(0) blur(6px);
    }

    .gb-screen.boot-on {
      animation: bootOn 1200ms ease-out forwards;
    }

    @keyframes bootOn {
      0% {
        opacity: 0;
        filter: brightness(0) blur(8px);
      }
      20% {
        opacity: 0.25;
        filter: brightness(0.3) blur(4px);
      }
      55% {
        opacity: 0.65;
        filter: brightness(1.6) blur(1px);
      }
      75% {
        opacity: 1;
        filter: brightness(1.15) blur(0px);
      }
      100% {
        opacity: 1;
        filter: brightness(1) blur(0px);
      }
    }

    .boot-flash::after {
      content: "";
      position: absolute;
      inset: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      animation: bootFlash 520ms ease-out;
    }

    @keyframes bootFlash {
      0% { opacity: 0; }
      15% { opacity: 0.35; }
      35% { opacity: 0.15; }
      55% { opacity: 0.08; }
      100% { opacity: 0; }
    }

    /* SENSOR PANEL -------------------------------------------------------- */

    .sensor-panel {
      position: fixed;
      left: 50%;
      bottom: max(18px, env(safe-area-inset-bottom, 18px));
      transform: translateX(-50%);
      width: 100%;
      max-width: 420px;
      padding: 0 10px;
      z-index: 20;
    }

    .sensor-panel-inner {
      background: rgba(15, 23, 42, 0.97);
      border-radius: 18px;
      padding: 10px 14px 8px;
      box-shadow:
        0 16px 40px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      border: 1px solid rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-family: "Saira", system-ui, sans-serif;
      font-size: 11px;
    }

    .sensor-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 4px;
    }

    .sensor-text {
      font-size: 10px;
      line-height: 1.4;
      opacity: 0.9;
    }

    .sensor-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .sensor-btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: linear-gradient(135deg, #111827, #020617);
      color: #e5e7eb;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-family: "Saira", sans-serif;
      cursor: pointer;
      box-shadow:
        0 10px 26px rgba(0,0,0,0.85),
        0 0 0 1px rgba(0,0,0,0.7);
    }

    .sensor-panel.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Sensor / mic permission panel -->
  <div class="sensor-panel" id="sensorPanel">
    <div class="sensor-panel-inner">
      <div class="sensor-title">Enable Motion &amp; Mic</div>
      <div class="sensor-text">
        Mount your phone in its normal driving position, then tap Allow.
        Emoji Buddy will treat this as â€œzeroâ€ and react to bumps, G-forces, and sound.
        No data is stored or shared; all processing happens locally on your device.
      </div>
      <div class="sensor-actions">
        <button class="sensor-btn" id="sensorBtn">Allow</button>
      </div>
    </div>
  </div>

  <div class="canvas">
    <div class="gb-shell" id="gb" data-color="grape">
      <div class="gb-top">
        <div class="gb-brand">Emoji Buddy</div>
        <div class="gb-top-right">Opulent Hardware</div>
      </div>

      <div class="gb-screen-frame">
        <div class="gb-screen boot-off boot-flash" id="screen">
          <div class="motion-graph-shell" id="motionRegion">
            <canvas class="motion-graph-canvas" id="motionCanvas"></canvas>
          </div>
          <div class="emoji-wrap" id="emojiWrap">
            <div class="emoji" id="emoji">ğŸ˜€</div>
          </div>
        </div>
      </div>

      <div class="gb-bottom">
        <div class="speaker" id="speaker">
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
        </div>

        <div class="color-strip">
          <span class="color-label">Color</span>
          <div class="color-swatches" id="colorMenu">
            <button class="color-swatch" data-color="grape"></button>
            <button class="color-swatch" data-color="teal"></button>
            <button class="color-swatch" data-color="kiwi"></button>
            <button class="color-swatch" data-color="berry"></button>
            <button class="color-swatch" data-color="smoke"></button>
            <button class="color-swatch" data-color="black"></button>
            <button class="color-swatch" data-color="beige"></button>
          </div>
        </div>

        <div class="size-strip">
          <span class="size-dial-label">Size</span>
          <div class="size-dial-wrap">
            <div class="size-dial" id="sizeDial">
              <div class="size-dial-notch"></div>
            </div>
          </div>
        </div>

        <div class="status-strip">
          <div class="vibe-label">Vibes</div>
          <div class="vibe-gauge">
            <div class="vibe-fill" id="vibeFill"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Emoji logic & pools ----------
    const EMOJI_ALL = [
      "ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ¥²","ğŸ¥¹","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ",
      "ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥¸","ğŸ¤©",
      "ğŸ¥³","ğŸ™‚â€â†•ï¸","ğŸ˜","ğŸ˜’","ğŸ™‚â€â†”ï¸","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º",
      "ğŸ˜¢","ğŸ˜­","ğŸ˜®â€ğŸ’¨","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ«£",
      "ğŸ¤—","ğŸ«¡","ğŸ¤”","ğŸ«¢","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜¶â€ğŸŒ«ï¸","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ«¨","ğŸ« ","ğŸ™„","ğŸ˜¯","ğŸ˜¦",
      "ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´","ğŸ«©","ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ˜µâ€ğŸ’«","ğŸ«¥","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·",
      "ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘¹","ğŸ‘º","ğŸ¤¡","ğŸ’©","ğŸ‘»","ğŸ’€","â˜ ï¸","ğŸ‘½","ğŸ‘¾","ğŸ¤–","ğŸƒ",
      "ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾"
    ];

    const EMOJI_CALM_REST   = ["ğŸ˜Œ","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ˜´","ğŸ«©","ğŸ˜ª"];
    const EMOJI_HARD_G      = ["ğŸ˜ˆ","ğŸ‘¿","ğŸ¤¬","ğŸ˜¤","ğŸ¤¯","ğŸ˜±","ğŸ˜³","ğŸ’©","ğŸ‘¹","ğŸ‘º"];
    const EMOJI_CRUISE      = ["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜","ğŸ¤ ","ğŸ¤©","ğŸ¥³","ğŸ˜º","ğŸ˜¸","ğŸ˜»"];
    const EMOJI_ROUGH_ROAD  = ["ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¥´","ğŸ˜µ","ğŸ˜µâ€ğŸ’«"];
    const EMOJI_CALM_MUSIC  = ["ğŸ˜Œ","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ¤—","ğŸ«¡","ğŸ« "];
    const EMOJI_HYPE_MUSIC  = ["ğŸ¤©","ğŸ¥³","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ˜ˆ","ğŸ˜","ğŸ¤ "];

    function classifyState(motion, audio) {
      const { mag, jitter, lastActiveTime } = motion;
      const level = audio.level ?? 0;

      const isVeryStill  = mag < 0.08 && jitter < 0.05;
      const now = Date.now();
      const stillMs = now - lastActiveTime;

      const deepRestActive = isVeryStill && level < 0.08 && stillMs > 30000;

      const isRoughRoad  = jitter > 0.35;
      const isHardG      = mag > 0.65;
      const isCornerCruise = mag > 0.25 && mag <= 0.65;

      const isCalmMusic  = level > 0.05 && level < 0.25;
      const isHypeMusic  = level >= 0.25;

      if (deepRestActive) return "deepRest";

      if (isVeryStill) {
        if (level < 0.05) return "rest";
        if (isCalmMusic)  return "calmMusic";
        if (isHypeMusic)  return "hypeMusic";
        return "rest";
      }

      if (isRoughRoad)    return "roughRoad";
      if (isHardG)        return "hardG";
      if (isCornerCruise) return "cruise";

      if (isHypeMusic) return "hypeMusic";
      if (isCalmMusic) return "calmMusic";

      return "neutral";
    }

    function randomEmojiFrom(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    function pickEmojiForState(state, prevEmoji) {
      let pool;

      switch (state) {
        case "deepRest":
          pool = ["ğŸ˜´"];
          break;
        case "rest":
          pool = EMOJI_CALM_REST;
          break;
        case "hardG":
          pool = EMOJI_HARD_G;
          break;
        case "cruise":
          pool = EMOJI_CRUISE;
          break;
        case "roughRoad":
          pool = EMOJI_ROUGH_ROAD;
          break;
        case "calmMusic":
          pool = EMOJI_CALM_MUSIC;
          break;
        case "hypeMusic":
          pool = EMOJI_HYPE_MUSIC;
          break;
        case "neutral":
        default:
          pool = EMOJI_ALL;
          break;
      }

      // allow a bit of chaos in non-calm states
      if (state !== "rest" && state !== "calmMusic" && state !== "deepRest") {
        if (Math.random() < 0.2) {
          pool = EMOJI_ALL;
        }
      }

      let next = randomEmojiFrom(pool);
      if (pool.length > 1 && next === prevEmoji) {
        next = randomEmojiFrom(pool);
      }

      return next;
    }

    function vibeBaseFromEmoji(e) {
      let level = 0.5;

      const happySet = "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£â˜ºï¸ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ˜‹ğŸ˜›ğŸ˜ğŸ˜œğŸ¤ªğŸ˜ğŸ¤©ğŸ¥³ğŸ¤—ğŸ¤ ğŸ˜ºğŸ˜¸ğŸ˜¹ğŸ˜»ğŸ˜¼ğŸ˜½";
      const lowSet   = "ğŸ˜ğŸ˜”ğŸ˜ŸğŸ˜•ğŸ™â˜¹ï¸ğŸ˜£ğŸ˜–ğŸ˜«ğŸ˜©ğŸ¥ºğŸ˜¢ğŸ˜­ğŸ˜®â€ğŸ’¨ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ˜³ğŸ˜°ğŸ˜¥ğŸ˜“ğŸ˜¿ğŸ˜¾";
      const hotSet   = "ğŸ¥µğŸ¤¯ğŸ˜±ğŸ˜¨ğŸ˜µğŸ˜µâ€ğŸ’«";
      const sickSet  = "ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¥´";

      if (happySet.includes(e)) level = 0.82;
      else if (hotSet.includes(e)) level = 1.0;
      else if (sickSet.includes(e)) level = 0.3;
      else if (lowSet.includes(e)) level = 0.2;
      else level = 0.55;

      return level;
    }

    // ---------- Motion manager with baseline ----------
    class MotionManager {
      constructor(onUpdate) {
        this.onUpdate = onUpdate;
        this.motionX = 0;
        this.motionY = 0;
        this.prevMotionX = 0;
        this.prevMotionY = 0;
        this.motionMag = 0;
        this.motionJitter = 0;
        this.lastActiveTime = Date.now();

        // baseline (zero) for mounted orientation
        this.baseX = 0;
        this.baseY = 0;
        this.baseZ = 0;
        this.calibrated = false;
      }

      async start() {
        if (typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function") {
          try {
            const res = await DeviceMotionEvent.requestPermission();
            if (res !== "granted") return;
          } catch (e) {
            console.warn("Motion permission error:", e);
            return;
          }
        }

        window.addEventListener("devicemotion", this.handleMotion.bind(this), true);
      }

      handleMotion(event) {
        const acc = event.accelerationIncludingGravity;
        if (!acc) return;

        let ax = acc.x || 0;
        let ay = acc.y || 0;
        let az = acc.z || 0;

        // First samples after mount: treat as baseline gravity
        if (!this.calibrated) {
          this.baseX = ax;
          this.baseY = ay;
          this.baseZ = az;
          this.calibrated = true;
        }

        // Subtract baseline so mounted portrait = "zero"
        ax -= this.baseX;
        ay -= this.baseY;
        az -= this.baseZ;

        const sensitivity = 6.0;
        const maxOffset   = 32;

        let targetX = ax * sensitivity;
        let targetY = -ay * sensitivity;

        targetX = Math.max(-maxOffset, Math.min(maxOffset, targetX));
        targetY = Math.max(-maxOffset, Math.min(maxOffset, targetY));

        const alpha = 0.25;
        this.motionX = this.motionX + alpha * (targetX - this.motionX);
        this.motionY = this.motionY + alpha * (targetY - this.motionY);

        const normX = Math.max(-1, Math.min(1, this.motionX / maxOffset));
        const normY = Math.max(-1, Math.min(1, this.motionY / maxOffset));

        const magRaw = Math.min(
          1,
          Math.sqrt(this.motionX * this.motionX + this.motionY * this.motionY) / maxOffset
        );
        const magAlpha = 0.1;
        this.motionMag = this.motionMag + magAlpha * (magRaw - this.motionMag);

        const diff = Math.abs(this.motionX - this.prevMotionX) +
                     Math.abs(this.motionY - this.prevMotionY);
        this.prevMotionX = this.motionX;
        this.prevMotionY = this.motionY;

        const diffNorm = Math.min(1, diff / 20);
        const jitterAlpha = 0.15;
        this.motionJitter = this.motionJitter + jitterAlpha * (diffNorm - this.motionJitter);

        if (magRaw > 0.03 || diffNorm > 0.03) {
          this.lastActiveTime = Date.now();
        }

        this.onUpdate({
          motionX: this.motionX,
          motionY: this.motionY,
          normX,
          normY,
          mag: this.motionMag,
          jitter: this.motionJitter,
          lastActiveTime: this.lastActiveTime
        });
      }
    }

    // ---------- Audio manager ----------
    class AudioManager {
      constructor(onUpdate) {
        this.onUpdate = onUpdate;
        this.audioLevel = 0;
      }

      async start() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          console.warn("getUserMedia not supported");
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: false
            }
          });

          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const audioCtx = new AudioCtx();
          await audioCtx.resume();

          const source = audioCtx.createMediaStreamSource(stream);
          const analyser = audioCtx.createAnalyser();
          analyser.fftSize = 1024;
          const data = new Uint8Array(analyser.frequencyBinCount);
          source.connect(analyser);

          const loop = () => {
            analyser.getByteFrequencyData(data);
            let sum = 0;
            for (let i = 0; i < data.length; i++) sum += data[i];
            const avg = sum / data.length;
            const norm = avg / 255;
            let level = Math.min(1, norm * 3);

            const aAlpha = 0.12;
            this.audioLevel = this.audioLevel + aAlpha * (level - this.audioLevel);

            this.onUpdate({ level: this.audioLevel });

            requestAnimationFrame(loop);
          };

          loop();
        } catch (err) {
          console.warn("Audio permission error:", err);
        }
      }
    }

    // ---------- Screen UI ----------
    class ScreenUI {
      constructor() {
        this.gbEl       = document.getElementById("gb");
        this.screenEl   = document.getElementById("screen");
        this.emojiEl    = document.getElementById("emoji");
        this.vibeFillEl = document.getElementById("vibeFill");
        this.colorMenu  = document.getElementById("colorMenu");
        this.sizeDial   = document.getElementById("sizeDial");

        this.sizeLevels = [0.85, 1.0, 1.2];
        this.sizeAngles = [-20, 0, 20];
        this.sizeIndex  = 1;

        this.vibeBaseLevel = 0.5;

        this.initColor();
        this.initSizeDial();
      }

      initColor() {
        try {
          const saved = localStorage.getItem("emojiBuddyColor");
          if (saved) this.gbEl.setAttribute("data-color", saved);
        } catch (_) {}

        this.colorMenu.addEventListener("click", (e) => {
          const target = e.target.closest(".color-swatch");
          if (!target) return;
          const color = target.dataset.color;
          this.gbEl.setAttribute("data-color", color);
          try { localStorage.setItem("emojiBuddyColor", color); } catch(_) {}
          if (this.onColorChange) this.onColorChange();
        });
      }

      initSizeDial() {
        this.applySize();
        this.sizeDial.addEventListener("click", () => {
          this.sizeIndex = (this.sizeIndex + 1) % this.sizeLevels.length;
          this.applySize();
          if (this.onInteraction) this.onInteraction();
        });
      }

      applySize() {
        const scale = this.sizeLevels[this.sizeIndex];
        document.documentElement.style.setProperty("--emoji-scale", scale);
        this.sizeDial.style.transform = `rotate(${this.sizeAngles[this.sizeIndex]}deg)`;
      }

      forceCenterEmoji() {
        document.documentElement.style.setProperty("--emoji-offset-x", "0px");
        document.documentElement.style.setProperty("--emoji-offset-y", "0px");
      }

      updateMotionOffset(motionX, motionY) {
        document.documentElement.style.setProperty("--emoji-offset-x", motionX.toFixed(1) + "px");
        document.documentElement.style.setProperty("--emoji-offset-y", motionY.toFixed(1) + "px");
      }

      updateAudioGlow(level) {
        document.documentElement.style
          .setProperty("--audio-glow", (level * 1.0).toFixed(3));

        const pulsed = Math.min(1, this.vibeBaseLevel * (0.7 + level * 1.0));
        this.vibeFillEl.style.transform = `scaleX(${pulsed.toFixed(3)})`;

        const extra = 10 + level * 32;
        this.vibeFillEl.style.boxShadow =
          `0 0 ${extra.toFixed(1)}px rgba(250, 204, 21, 0.98)`;
      }

      setEmoji(emoji, state) {
        this.emojiEl.textContent = emoji;

        this.emojiEl.classList.remove("emoji-pop", "emoji-hard-g");
        void this.emojiEl.offsetWidth;

        if (state === "hardG") {
          this.emojiEl.classList.add("emoji-hard-g");
        } else {
          this.emojiEl.classList.add("emoji-pop");
        }

        this.gbEl.classList.remove("wobble");
        void this.gbEl.offsetWidth;
        this.gbEl.classList.add("wobble");

        const base = vibeBaseFromEmoji(emoji);
        this.vibeBaseLevel = base;
        this.vibeFillEl.style.transform = `scaleX(${base})`;
      }

      getCurrentThemeLightColor() {
        const styles = getComputedStyle(this.gbEl);
        return styles.getPropertyValue("--shell-light").trim() || "#7c3aed";
      }

      boot() {
        this.screenEl.classList.add("boot-off");
        this.screenEl.classList.add("boot-flash");

        setTimeout(() => {
          this.screenEl.classList.add("boot-on");
          this.screenEl.classList.remove("boot-off");

          setTimeout(() => {
            this.screenEl.classList.remove("boot-flash");
          }, 600);
        }, 260);
      }
    }

    // ---------- Motion graph UI ----------
    class MotionGraphUI {
      constructor() {
        this.region  = document.getElementById("motionRegion");
        this.canvas  = document.getElementById("motionCanvas");
        this.ctx     = this.canvas.getContext("2d");
        this.enabled = false;
        this.trail   = [];
        this.TRAIL_LENGTH = 20;
        this.width   = 0;
        this.height  = 0;
        this.color   = "#7c3aed";

        window.addEventListener("resize", () => this.resize());
        this.resize();
        this.renderLoop();
      }

      setEnabled(on) {
        this.enabled = on;
        if (on) {
          this.canvas.classList.add("active");
        } else {
          this.canvas.classList.remove("active");
          this.trail = [];
          this.ctx.clearRect(0, 0, this.width, this.height);
        }
      }

      toggle() {
        this.setEnabled(!this.enabled);
      }

      setColor(color) {
        this.color = color || "#7c3aed";
      }

      resize() {
        const rect = this.region.getBoundingClientRect();
        const dpr  = window.devicePixelRatio || 1;
        this.width  = rect.width;
        this.height = rect.height;
        this.canvas.width  = this.width * dpr;
        this.canvas.height = this.height * dpr;
        this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      update(normX, normY) {
        if (!this.enabled || !this.width || !this.height) return;

        const margin = 4;
        const cx = this.width / 2;
        const cy = this.height / 2;
        const maxX = (this.width / 2) - margin;
        const maxY = (this.height / 2) - margin;

        const px = cx + normX * maxX;
        const py = cy + normY * maxY;

        this.trail.unshift({ x: px, y: py });
        if (this.trail.length > this.TRAIL_LENGTH) this.trail.pop();
      }

      draw() {
        if (!this.width || !this.height) return;

        this.ctx.clearRect(0, 0, this.width, this.height);
        if (!this.enabled) return;

        const spacing = 8;
        this.ctx.save();
        this.ctx.fillStyle = this.color;
        this.ctx.globalAlpha = 0.16;
        for (let y = 2; y < this.height; y += spacing) {
          for (let x = 2; x < this.width; x += spacing) {
            this.ctx.fillRect(x, y, 1.5, 1.5);
          }
        }
        this.ctx.restore();

        for (let i = 0; i < this.trail.length; i++) {
          const t = this.trail[i];
          const alpha = 1 - i / this.TRAIL_LENGTH;
          const size = 5 - (i * 0.08);
          const half = size / 2;

          this.ctx.save();
          this.ctx.globalAlpha = 0.22 + alpha * 0.6;
          this.ctx.fillStyle = this.color;
          this.ctx.fillRect(t.x - half, t.y - half, size, size);
          this.ctx.restore();
        }
      }

      renderLoop() {
        this.draw();
        requestAnimationFrame(() => this.renderLoop());
      }
    }

    // ---------- Main wiring ----------

    const screenUI    = new ScreenUI();
    const graphUI     = new MotionGraphUI();
    const sensorPanel = document.getElementById("sensorPanel");
    const sensorBtn   = document.getElementById("sensorBtn");
    const speakerEl   = document.getElementById("speaker");
    const screenEl    = document.getElementById("screen");

    let motionState = {
      motionX: 0,
      motionY: 0,
      normX: 0,
      normY: 0,
      mag: 0,
      jitter: 0,
      lastActiveTime: Date.now()
    };

    let audioState  = { level: 0 };
    let currentEmoji = "ğŸ˜€";
    let currentState = "rest";

    let autoEnabled = false;
    let lastInteraction = Date.now();
    let lastChange = Date.now();
    let holdMs = randomHoldDuration();

    function randomHoldDuration() {
      return 2000 + Math.random() * 28000;
    }

    const motionManager = new MotionManager((state) => {
      motionState = state;
      screenUI.updateMotionOffset(state.motionX, state.motionY);
      graphUI.update(state.normX, state.normY);
    });

    const audioManager = new AudioManager((state) => {
      audioState = state;
      screenUI.updateAudioGlow(state.level);
    });

    screenUI.onColorChange = () => {
      const color = screenUI.getCurrentThemeLightColor();
      graphUI.setColor(color);
    };

    screenUI.onInteraction = () => {
      lastInteraction = Date.now();
      autoEnabled = false;
    };

    // Manual tap on screen => change emoji by context
    screenEl.addEventListener("click", () => {
      lastInteraction = Date.now();
      autoEnabled = false;
      changeEmojiFromContext(true);
    });

    // Speaker => toggle graph
    speakerEl.addEventListener("click", (e) => {
      e.stopPropagation();
      graphUI.toggle();
    });

    speakerEl.addEventListener("touchend", (e) => {
      e.preventDefault();
      e.stopPropagation();
      graphUI.toggle();
    }, { passive: false });

    // Sensor panel allow
    sensorBtn.addEventListener("click", async () => {
      await Promise.allSettled([
        motionManager.start(),
        audioManager.start()
      ]);
      sensorPanel.classList.add("hidden");
    });

    function changeEmojiFromContext(force = false) {
      const newState = classifyState(motionState, audioState);
      const emoji = pickEmojiForState(newState, currentEmoji);
      currentEmoji = emoji;
      currentState = newState;
      lastChange = Date.now();
      holdMs = randomHoldDuration();
      screenUI.setEmoji(emoji, newState);
    }

    function tick() {
      const now = Date.now();
      const idle = now - lastInteraction;

      const newState = classifyState(motionState, audioState);

      const stateChanged = newState !== currentState;
      const interestingStates = new Set(["hardG", "roughRoad", "hypeMusic"]);
      if (stateChanged && interestingStates.has(newState)) {
        changeEmojiFromContext(true);
      } else {
        currentState = newState;
      }

      if (!autoEnabled && idle >= 10000) {
        autoEnabled = true;
        lastChange = now;
        holdMs = randomHoldDuration();
      }

      if (autoEnabled && now - lastChange >= holdMs) {
        changeEmojiFromContext();
      }
    }

    setInterval(tick, 400);

    function init() {
      screenUI.forceCenterEmoji();

      const initState = classifyState(motionState, audioState);
      const initEmoji = pickEmojiForState(initState, currentEmoji);
      currentEmoji = initEmoji;
      currentState = initState;
      screenUI.setEmoji(initEmoji, initState);

      const color = screenUI.getCurrentThemeLightColor();
      graphUI.setColor(color);

      screenUI.boot();
    }

    init();
  </script>
</body>
</html>
