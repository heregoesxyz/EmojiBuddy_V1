<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Emoji Buddy Â· Opulent Hardware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Brand font -->
  <link href="https://fonts.googleapis.com/css2?family=Saira:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --shell-main: #4c1d95;
      --shell-dark: #2e1065;
      --shell-light: #7c3aed;
      --accent: #facc15;
      --ring-soft: rgba(148, 163, 184, 0.16);
      --emoji-scale: 1;
      --emoji-offset-x: 0px;
      --emoji-offset-y: 0px;
      --audio-glow: 0; /* 0â€“1 for LCD glow */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color: #e5e7eb;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .canvas {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    /* SHELL --------------------------------------------------------------- */

    .gb-shell {
      position: relative;
      width: min(420px, 96vw);
      aspect-ratio: 3 / 4;
      border-radius: 30px;
      background:
        radial-gradient(circle at -10% -20%, rgba(255, 255, 255, 0.10), transparent 55%),
        radial-gradient(circle at 110% 120%, rgba(15, 23, 42, 0.65), transparent 60%),
        linear-gradient(135deg, var(--shell-main), var(--shell-dark));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.8),
        0 24px 60px rgba(0, 0, 0, 0.95);
      padding: 14px 14px 18px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      row-gap: 10px;
      position: relative;
    }

    /* color themes */

    .gb-shell[data-color="grape"] {
      --shell-main: #4c1d95;
      --shell-dark: #2e1065;
      --shell-light: #7c3aed;
      --accent: #facc15;
      --ring-soft: rgba(196, 181, 253, 0.35);
    }

    .gb-shell[data-color="teal"] {
      --shell-main: #0f766e;
      --shell-dark: #115e59;
      --shell-light: #2dd4bf;
      --accent: #fbbf24;
      --ring-soft: rgba(45, 212, 191, 0.35);
    }

    .gb-shell[data-color="kiwi"] {
      --shell-main: #15803d;
      --shell-dark: #14532d;
      --shell-light: #4ade80;
      --accent: #facc15;
      --ring-soft: rgba(74, 222, 128, 0.35);
    }

    .gb-shell[data-color="berry"] {
      --shell-main: #9f1239;
      --shell-dark: #881337;
      --shell-light: #fb7185;
      --accent: #fbbf24;
      --ring-soft: rgba(248, 113, 113, 0.35);
    }

    .gb-shell[data-color="smoke"] {
      --shell-main: #374151;
      --shell-dark: #111827;
      --shell-light: #9ca3af;
      --accent: #22c55e;
      --ring-soft: rgba(148, 163, 184, 0.35);
    }

    .gb-shell[data-color="black"] {
      --shell-main: #020617;
      --shell-dark: #000000;
      --shell-light: #4b5563;
      --accent: #facc15;
      --ring-soft: rgba(148, 163, 184, 0.4);
    }

    .gb-shell[data-color="beige"] {
      --shell-main: #d9c9a3;
      --shell-dark: #b7966b;
      --shell-light: #f3e7c8;
      --accent: #22c55e;
      --ring-soft: rgba(150, 120, 80, 0.4);
    }

    .gb-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: conic-gradient(
        from 140deg,
        var(--ring-soft),
        rgba(31, 41, 55, 0.8),
        rgba(15, 23, 42, 0.3),
        var(--ring-soft)
      );
      mix-blend-mode: screen;
      opacity: 0.6;
      pointer-events: none;
    }

    .gb-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: 0 0 42px rgba(15, 23, 42, 0.95) inset;
      pointer-events: none;
    }

    /* TOP BAR ------------------------------------------------------------- */

    .gb-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2px;
      position: relative;
      z-index: 1;
      font-family: "Saira", system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    .gb-brand,
    .gb-top-right {
      font-family: "Saira", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(0,0,0,0.85);
      text-shadow:
        0 0 3px rgba(255,255,255,0.30),
        0 0 6px rgba(0,0,0,0.40);
    }

    .gb-brand {
      font-size: 13px;
      font-weight: 600;
    }

    .gb-top-right {
      font-size: 11px;
      font-weight: 500;
    }

    /* SCREEN -------------------------------------------------------------- */

    .gb-screen-frame {
      border-radius: 18px;
      padding: 8px;
      background:
        linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.85),
        0 10px 20px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .gb-screen {
      flex: 1;
      margin-top: 2px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 50% 0%, rgba(248, 250, 252, 0.08), transparent 60%),
        linear-gradient(180deg, #020617, #020617 60%, #020617);
      box-shadow:
        0 0 0 1px #020617,
        0 0 45px rgba(15, 23, 42, 0.9) inset;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      position: relative;
      opacity: 1;
      filter: brightness(1) blur(0);
    }

    .gb-screen::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0%, rgba(248, 250, 252, 0.18), transparent 70%);
      opacity: 0.5;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    /* audio glow overlay */
    .gb-screen::after {
      content: "";
      position: absolute;
      inset: -12%;
      background: radial-gradient(circle at 50% 0%, var(--shell-light), transparent 60%);
      mix-blend-mode: screen;
      opacity: var(--audio-glow);
      pointer-events: none;
      transition: opacity 80ms linear;
    }

    /* MOTION GRAPH -------------------------------------------------------- */

    .motion-graph-shell {
      position: absolute;
      top: 6px;
      left: 8px;
      right: 8px;
      height: 30px;
      z-index: 2;
      pointer-events: none;
    }

    .motion-graph-canvas {
      width: 100%;
      height: 100%;
      display: block;
      opacity: 0;
      transition: opacity 180ms ease-out;
    }

    .motion-graph-canvas.active {
      opacity: 1;
    }

    .emoji-wrap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transform: translate3d(var(--emoji-offset-x), var(--emoji-offset-y), 0)
                 scale(var(--emoji-scale));
      transition: transform 80ms linear;
    }

    .emoji {
      position: relative;
      font-size: 180px;
      line-height: 1;
      filter: drop-shadow(0 0 10px rgba(15, 23, 42, 0.9));
      transform-origin: center;
      animation: breathe 6s ease-in-out infinite;
    }

    @keyframes breathe {
      0%   { transform: translateY(0); }
      50%  { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }

    .emoji-pop {
      animation: emojiPop 260ms ease-out, breathe 6s ease-in-out 260ms infinite;
    }

    @keyframes emojiPop {
      0%   { transform: scale(0.88); }
      60%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* BOTTOM CONTROLS ----------------------------------------------------- */

    .gb-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .speaker {
      display: grid;
      grid-template-columns: repeat(3, 5px);
      grid-auto-rows: 5px;
      gap: 4px;
      opacity: 0.6;
      filter: drop-shadow(0 1px 0 rgba(15, 23, 42, 0.5));
      cursor: pointer;
    }

    .speaker-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .color-strip {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .color-label {
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .color-swatches {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      box-shadow:
        0 8px 20px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      cursor: pointer;
      padding: 0;
      outline: none;
    }

    .color-swatch[data-color="grape"] { background: linear-gradient(135deg,#7c3aed,#4c1d95); }
    .color-swatch[data-color="teal"]  { background: linear-gradient(135deg,#2dd4bf,#0f766e); }
    .color-swatch[data-color="kiwi"]  { background: linear-gradient(135deg,#4ade80,#15803d); }
    .color-swatch[data-color="berry"] { background: linear-gradient(135deg,#fb7185,#9f1239); }
    .color-swatch[data-color="smoke"] { background: linear-gradient(135deg,#9ca3af,#374151); }
    .color-swatch[data-color="black"] { background: linear-gradient(135deg,#020617,#111827); }
    .color-swatch[data-color="beige"] { background: linear-gradient(135deg,#f3e7c8,#b7966b); }

    .status-strip {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .vibe-label {
      opacity: 0.9;
    }

    .vibe-gauge {
      width: 72px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      background:
        radial-gradient(circle at 0 50%, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 1));
      overflow: hidden;
      position: relative;
    }

    .vibe-fill {
      position: absolute;
      inset: 0;
      transform-origin: left center;
      transform: scaleX(0.5);
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #facc15, #f97316);
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.8);
      transition: transform 120ms ease-out, box-shadow 80ms ease-out;
    }

    /* SIZE DIAL ----------------------------------------------------------- */

    .size-strip {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-family: "Saira", sans-serif;
      font-size: 8px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.75);
      text-shadow:
        0 0 3px rgba(255, 255, 255, 0.35),
        0 0 6px rgba(0, 0, 0, 0.45);
    }

    .size-dial-wrap {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .size-dial {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(248, 250, 252, 0.25), transparent 60%),
        linear-gradient(145deg, #111827, #020617);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.95),
        0 3px 6px rgba(0, 0, 0, 0.8);
      position: relative;
      cursor: pointer;
      transition: box-shadow 120ms ease-out, transform 120ms ease-out;
    }

    .size-dial-notch {
      position: absolute;
      top: 2px;
      left: 50%;
      width: 2px;
      height: 8px;
      border-radius: 999px;
      background: #f9fafb;
      transform: translateX(-50%);
      box-shadow: 0 0 4px rgba(248, 250, 252, 0.8);
    }

    .size-dial-label {
      font-size: 8px;
    }

    .wobble {
      animation: wobble 520ms ease-in-out;
    }

    @keyframes wobble {
      0%   { transform: translateX(0) rotate(0deg); }
      20%  { transform: translateX(-2px) rotate(-0.45deg); }
      40%  { transform: translateX(3px) rotate(0.45deg); }
      65%  { transform: translateX(-1.5px) rotate(-0.25deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }

    /* STARTUP BOOT SEQUENCE ----------------------------------------------- */

    .gb-screen.boot-off {
      opacity: 0;
      filter: brightness(0) blur(6px);
    }

    .gb-screen.boot-on {
      animation: bootOn 1200ms ease-out forwards;
    }

    @keyframes bootOn {
      0% {
        opacity: 0;
        filter: brightness(0) blur(8px);
      }
      20% {
        opacity: 0.25;
        filter: brightness(0.3) blur(4px);
      }
      55% {
        opacity: 0.65;
        filter: brightness(1.6) blur(1px);
      }
      75% {
        opacity: 1;
        filter: brightness(1.15) blur(0px);
      }
      100% {
        opacity: 1;
        filter: brightness(1) blur(0px);
      }
    }

    .boot-flash::after {
      content: "";
      position: absolute;
      inset: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      animation: bootFlash 520ms ease-out;
    }

    @keyframes bootFlash {
      0% { opacity: 0; }
      15% { opacity: 0.35; }
      35% { opacity: 0.15; }
      55% { opacity: 0.08; }
      100% { opacity: 0; }
    }

    /* SENSOR PANEL -------------------------------------------------------- */

    .sensor-panel {
      position: fixed;
      left: 50%;
      bottom: max(18px, env(safe-area-inset-bottom, 18px));
      transform: translateX(-50%);
      width: 100%;
      max-width: 420px;
      padding: 0 10px;
      z-index: 20;
    }

    .sensor-panel-inner {
      background: rgba(15, 23, 42, 0.97);
      border-radius: 18px;
      padding: 10px 14px 8px;
      box-shadow:
        0 16px 40px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      border: 1px solid rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-family: "Saira", system-ui, sans-serif;
      font-size: 11px;
    }

    .sensor-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 4px;
    }

    .sensor-text {
      font-size: 10px;
      line-height: 1.4;
      opacity: 0.9;
    }

    .sensor-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .sensor-btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: linear-gradient(135deg, #111827, #020617);
      color: #e5e7eb;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-family: "Saira", sans-serif;
      cursor: pointer;
      box-shadow:
        0 10px 26px rgba(0,0,0,0.85),
        0 0 0 1px rgba(0,0,0,0.7);
    }

    .sensor-panel.hidden {
      display: none;
    }

  </style>
</head>

<body>
  <!-- Sensor / mic permission panel -->
  <div class="sensor-panel" id="sensorPanel">
    <div class="sensor-panel-inner">
      <div class="sensor-title">Enable Motion &amp; Mic</div>
      <div class="sensor-text">
        Emoji Buddy reacts to your car's movement and nearby sound.
        No data is stored or shared; all processing happens locally on your device.
      </div>
      <div class="sensor-actions">
        <button class="sensor-btn" id="sensorBtn">Allow</button>
      </div>
    </div>
  </div>

  <div class="canvas">
    <div class="gb-shell" id="gb" data-color="grape">

      <div class="gb-top">
        <div class="gb-brand">Emoji Buddy</div>
        <div class="gb-top-right">Opulent Hardware</div>
      </div>

      <div class="gb-screen-frame">
        <div class="gb-screen boot-off boot-flash" id="screen">
          <!-- Motion graph overlay -->
          <div class="motion-graph-shell" id="motionRegion">
            <canvas class="motion-graph-canvas" id="motionCanvas"></canvas>
          </div>

          <div class="emoji-wrap" id="emojiWrap">
            <div class="emoji" id="emoji">ğŸ˜€</div>
          </div>
        </div>
      </div>

      <div class="gb-bottom">

        <div class="speaker" id="speaker">
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
          <div class="speaker-dot"></div><div class="speaker-dot"></div><div class="speaker-dot"></div>
        </div>

        <div class="color-strip">
          <span class="color-label">Color</span>
          <div class="color-swatches" id="colorMenu">
            <button class="color-swatch" data-color="grape"></button>
            <button class="color-swatch" data-color="teal"></button>
            <button class="color-swatch" data-color="kiwi"></button>
            <button class="color-swatch" data-color="berry"></button>
            <button class="color-swatch" data-color="smoke"></button>
            <button class="color-swatch" data-color="black"></button>
            <button class="color-swatch" data-color="beige"></button>
          </div>
        </div>

        <div class="size-strip">
          <span class="size-dial-label">Size</span>
          <div class="size-dial-wrap">
            <div class="size-dial" id="sizeDial">
              <div class="size-dial-notch"></div>
            </div>
          </div>
        </div>

        <div class="status-strip">
          <div class="vibe-label">Vibes</div>
          <div class="vibe-gauge">
            <div class="vibe-fill" id="vibeFill"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  const emojiList = [
    "ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ¥²","ğŸ¥¹","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ",
    "ğŸ˜","ğŸ¥°","ğŸ˜˜","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥¸","ğŸ¤©",
    "ğŸ¥³","ğŸ™‚â€â†•ï¸","ğŸ˜","ğŸ˜’","ğŸ™‚â€â†”ï¸","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º",
    "ğŸ˜¢","ğŸ˜­","ğŸ˜®â€ğŸ’¨","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨","ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ«£",
    "ğŸ¤—","ğŸ«¡","ğŸ¤”","ğŸ«¢","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜¶â€ğŸŒ«ï¸","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ«¨","ğŸ« ","ğŸ™„","ğŸ˜¯","ğŸ˜¦",
    "ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´","ğŸ«©","ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ˜µâ€ğŸ’«","ğŸ«¥","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·",
    "ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘¹","ğŸ‘º","ğŸ¤¡","ğŸ’©","ğŸ‘»","ğŸ’€","â˜ ï¸","ğŸ‘½","ğŸ‘¾","ğŸ¤–","ğŸƒ",
    "ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾"
  ];

  // Context emoji pools ----------------------------------------
  const calmRestEmojis = ["ğŸ˜Œ","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ˜´","ğŸ«©","ğŸ˜ª"];
  const hardGEmojis    = ["ğŸ˜ˆ","ğŸ‘¿","ğŸ¤¬","ğŸ˜¤","ğŸ¤¯","ğŸ˜±","ğŸ˜³","ğŸ’©","ğŸ‘¹","ğŸ‘º"];
  const cruiseEmojis   = ["ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜","ğŸ¤ ","ğŸ¤©","ğŸ¥³","ğŸ˜º","ğŸ˜¸","ğŸ˜»"];
  const roughRoadEmojis= ["ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¥´","ğŸ˜µ","ğŸ˜µâ€ğŸ’«"];
  const calmMusicEmojis= ["ğŸ˜Œ","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ¤—","ğŸ«¡","ğŸ« "];
  const hypeMusicEmojis= ["ğŸ¤©","ğŸ¥³","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ˜ˆ","ğŸ˜","ğŸ¤ "];

  const gbEl        = document.getElementById("gb");
  const screenEl    = document.getElementById("screen");
  const emojiEl     = document.getElementById("emoji");
  const vibeFillEl  = document.getElementById("vibeFill");
  const colorMenu   = document.getElementById("colorMenu");
  const sizeDial    = document.getElementById("sizeDial");
  const sensorPanel = document.getElementById("sensorPanel");
  const sensorBtn   = document.getElementById("sensorBtn");

  const motionRegion = document.getElementById("motionRegion");
  const motionCanvas = document.getElementById("motionCanvas");
  const motionCtx    = motionCanvas.getContext("2d");
  const speakerEl    = document.getElementById("speaker");

  let currentEmoji    = "ğŸ˜€";
  let lastInteraction = Date.now();
  let lastChange      = Date.now();
  let autoEnabled     = false;
  let holdMs          = randomHoldDuration();

  const sizeLevels = [0.85, 1.0, 1.2];
  const sizeAngles = [-20, 0, 20];
  let sizeIndex    = 1;

  // motion state
  let motionX = 0, motionY = 0;
  let motionNormX = 0, motionNormY = 0;
  let motionMag = 0;     // 0â€“1 how strong G is
  let motionJitter = 0;  // 0â€“1 how jerky

  // for jitter
  let prevMotionX = 0;
  let prevMotionY = 0;

  // graph state
  let motionGraphEnabled = false;
  let motionGraphColor = "#7c3aed";
  let graphWidth = 0, graphHeight = 0;
  const TRAIL_LENGTH = 20;
  let trail = [];

  // audio state
  let audioLevel = 0;    // smoothed 0â€“1
  let vibeBaseLevel = 0.5;

  function randomHoldDuration() {
    return 2000 + Math.random() * 28000;
  }

  function randomEmojiFrom(list) {
    return list[Math.floor(Math.random() * list.length)];
  }

  function markInteraction() {
    lastInteraction = Date.now();
    autoEnabled = false;
  }

  function setEmoji(e) {
    if (!e) return;
    if (e === currentEmoji && Math.random() < 0.5) {
      // nudge to something else
      e = randomEmojiFrom(emojiList);
    }
    currentEmoji = e;
    emojiEl.textContent = e;

    emojiEl.classList.remove("emoji-pop");
    void emojiEl.offsetWidth;
    emojiEl.classList.add("emoji-pop");

    gbEl.classList.remove("wobble");
    void gbEl.offsetWidth;
    gbEl.classList.add("wobble");

    adjustVibeGauge(e);
  }

  function adjustVibeGauge(e) {
    let level = 0.5;

    const happySet = "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£â˜ºï¸ğŸ˜ŠğŸ˜‡ğŸ™‚ğŸ˜‰ğŸ˜ŒğŸ˜ğŸ¥°ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ˜‹ğŸ˜›ğŸ˜ğŸ˜œğŸ¤ªğŸ˜ğŸ¤©ğŸ¥³ğŸ¤—ğŸ¤ ğŸ˜ºğŸ˜¸ğŸ˜¹ğŸ˜»ğŸ˜¼ğŸ˜½";
    const lowSet   = "ğŸ˜ğŸ˜”ğŸ˜ŸğŸ˜•ğŸ™â˜¹ï¸ğŸ˜£ğŸ˜–ğŸ˜«ğŸ˜©ğŸ¥ºğŸ˜¢ğŸ˜­ğŸ˜®â€ğŸ’¨ğŸ˜¤ğŸ˜ ğŸ˜¡ğŸ¤¬ğŸ˜³ğŸ˜°ğŸ˜¥ğŸ˜“ğŸ˜¿ğŸ˜¾";
    const hotSet   = "ğŸ¥µğŸ¤¯ğŸ˜±ğŸ˜¨ğŸ˜µğŸ˜µâ€ğŸ’«";
    const sickSet  = "ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¥´";

    if (happySet.includes(e)) level = 0.82;
    else if (hotSet.includes(e)) level = 1.0;
    else if (sickSet.includes(e)) level = 0.3;
    else if (lowSet.includes(e)) level = 0.2;
    else level = 0.55;

    vibeBaseLevel = level;
    vibeFillEl.style.transform = `scaleX(${vibeBaseLevel})`;
  }

  // CLASSIFY STATE --------------------------------------------------------

  function classifyState() {
    // thresholds are tuned by feel
    const isVeryStill  = motionMag < 0.08 && motionJitter < 0.05;
    const isRoughRoad  = motionJitter > 0.35;
    const isHardG      = motionMag > 0.65;
    const isCornerCruise = motionMag > 0.25 && motionMag <= 0.65;

    const isCalmMusic  = audioLevel > 0.05 && audioLevel < 0.25;
    const isHypeMusic  = audioLevel >= 0.25;

    // parked / very chill
    if (isVeryStill) {
      if (audioLevel < 0.05) return "rest";
      if (isCalmMusic)       return "calmMusic";
      if (isHypeMusic)       return "hypeMusic";
      return "rest";
    }

    // moving
    if (isRoughRoad)   return "roughRoad";
    if (isHardG)       return "hardG";
    if (isCornerCruise)return "cruise";

    // neutral drive
    if (isHypeMusic)   return "hypeMusic";
    if (isCalmMusic)   return "calmMusic";

    return "neutral";
  }

  function pickContextEmoji() {
    const state = classifyState();

    let pool;

    switch (state) {
      case "rest":
        pool = calmRestEmojis;
        break;
      case "hardG":
        pool = hardGEmojis;
        break;
      case "cruise":
        pool = cruiseEmojis;
        break;
      case "roughRoad":
        pool = roughRoadEmojis;
        break;
      case "calmMusic":
        pool = calmMusicEmojis;
        break;
      case "hypeMusic":
        pool = hypeMusicEmojis;
        break;
      case "neutral":
      default:
        pool = emojiList;
        break;
    }

    // Sometimes pick from global list anyway so it doesn't get too samey
    if (Math.random() < 0.2) {
      pool = emojiList;
    }

    let next = randomEmojiFrom(pool);

    // avoid repeating the exact same emoji too often
    if (pool.length > 1 && next === currentEmoji) {
      next = randomEmojiFrom(pool);
    }

    return next;
  }

  function nextEmojiFromContext() {
    const chosen = pickContextEmoji();
    setEmoji(chosen);
  }

  function tick() {
    const now = Date.now();
    const idle = now - lastInteraction;

    if (!autoEnabled && idle >= 10000) {
      autoEnabled = true;
      lastChange = now;
      holdMs = randomHoldDuration();
    }

    if (autoEnabled && now - lastChange >= holdMs) {
      nextEmojiFromContext();
      lastChange = now;
      holdMs = randomHoldDuration();
    }
  }

  setInterval(tick, 500);

  colorMenu.addEventListener("click", e => {
    const target = e.target.closest(".color-swatch");
    if (!target) return;
    const color = target.dataset.color;
    gbEl.setAttribute("data-color", color);
    updateMotionGraphColor();
    markInteraction();
    try { localStorage.setItem("emojiBuddyColor", color); } catch(_) {}
  });

  function applySize() {
    const scale = sizeLevels[sizeIndex];
    document.documentElement.style.setProperty("--emoji-scale", scale);
    sizeDial.style.transform = `rotate(${sizeAngles[sizeIndex]}deg)`;
  }

  sizeDial.addEventListener("click", () => {
    sizeIndex = (sizeIndex + 1) % sizeLevels.length;
    applySize();
    markInteraction();
  });

  // Manual tap: change emoji, but using context logic
  screenEl.addEventListener("click", () => {
    markInteraction();
    nextEmojiFromContext();
  });

  /* MOTION HANDLING (hanging air freshener style) ------------------------ */

  function handleMotion(event) {
    const acc = event.accelerationIncludingGravity;
    if (!acc) return;

    const ax = acc.x || 0;
    const ay = acc.y || 0;
    const az = acc.z || 0;

    // Hanging charm behavior: move opposite of car acceleration
    // (car accelerates right => emoji drifts left, etc.)
    const sensitivity = 6.0;   // px per m/s^2
    const maxOffset   = 32;    // clamp

    // Orientation note: you may want to flip signs after road testing
    let targetX = ax * sensitivity;    // lateral
    let targetY = -ay * sensitivity;   // vertical

    targetX = Math.max(-maxOffset, Math.min(maxOffset, targetX));
    targetY = Math.max(-maxOffset, Math.min(maxOffset, targetY));

    const alpha = 0.25; // smoothing; smaller = heavier, more floaty
    motionX = motionX + alpha * (targetX - motionX);
    motionY = motionY + alpha * (targetY - motionY);

    document.documentElement.style.setProperty("--emoji-offset-x", motionX.toFixed(1) + "px");
    document.documentElement.style.setProperty("--emoji-offset-y", motionY.toFixed(1) + "px");

    // normalized for graph (-1 to 1)
    motionNormX = Math.max(-1, Math.min(1, motionX / maxOffset));
    motionNormY = Math.max(-1, Math.min(1, motionY / maxOffset));

    // motion magnitude (0â€“1)
    const magRaw = Math.min(1, Math.sqrt(motionX*motionX + motionY*motionY) / maxOffset);
    const magAlpha = 0.1;
    motionMag = motionMag + magAlpha * (magRaw - motionMag);

    // jitter based on frame-to-frame position changes
    const diff = Math.abs(motionX - prevMotionX) + Math.abs(motionY - prevMotionY);
    prevMotionX = motionX;
    prevMotionY = motionY;
    const diffNorm = Math.min(1, diff / 20); // tune this divisor for â€œroughnessâ€
    const jitterAlpha = 0.15;
    motionJitter = motionJitter + jitterAlpha * (diffNorm - motionJitter);
  }

  async function enableMotion() {
    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {
      try {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== "granted") return;
      } catch (err) {
        console.warn("Motion permission error:", err);
        return;
      }
    }
    window.addEventListener("devicemotion", handleMotion, true);
  }

  /* AUDIO (MIC) HANDLING ------------------------------------------------- */

  async function enableAudio() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn("getUserMedia not supported");
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: false
        }
      });

      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioCtx();
      await audioCtx.resume();

      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      const data = new Uint8Array(analyser.frequencyBinCount);
      source.connect(analyser);

      function audioLoop() {
        analyser.getByteFrequencyData(data);
        let sum = 0;
        for (let i = 0; i < data.length; i++) {
          sum += data[i];
        }
        const avg = sum / data.length;   // 0â€“255
        const norm = avg / 255;          // 0â€“1
        let level = Math.min(1, norm * 3);  // amplify

        // Smooth global audioLevel for state logic
        const aAlpha = 0.12;
        audioLevel = audioLevel + aAlpha * (level - audioLevel);

        // LCD glow amount
        document.documentElement
          .style
          .setProperty("--audio-glow", (level * 1.0).toFixed(3));

        // Vibes bar pulsing around base level
        const pulsed = Math.min(1, vibeBaseLevel * (0.7 + level * 1.0));
        vibeFillEl.style.transform = `scaleX(${pulsed.toFixed(3)})`;

        // Glow size
        const extra = 10 + level * 32;
        vibeFillEl.style.boxShadow = `0 0 ${extra.toFixed(1)}px rgba(250, 204, 21, 0.98)`;

        requestAnimationFrame(audioLoop);
      }

      audioLoop();
    } catch (err) {
      console.warn("Audio permission error:", err);
    }
  }

  /* MOTION GRAPH RENDERING ---------------------------------------------- */

  function resizeMotionCanvas() {
    const rect = motionRegion.getBoundingClientRect();
    const dpr  = window.devicePixelRatio || 1;
    graphWidth  = rect.width;
    graphHeight = rect.height;
    motionCanvas.width  = graphWidth * dpr;
    motionCanvas.height = graphHeight * dpr;
    motionCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function updateMotionGraphColor() {
    const styles = getComputedStyle(gbEl);
    const c = styles.getPropertyValue("--shell-light").trim();
    motionGraphColor = c || "#7c3aed";
  }

  function drawMotionGraph() {
    const w = graphWidth;
    const h = graphHeight;
    if (!w || !h) return;

    motionCtx.clearRect(0, 0, w, h);

    if (!motionGraphEnabled) return;

    // dotted "paper" grid
    const spacing = 8;
    motionCtx.save();
    motionCtx.fillStyle = motionGraphColor;
    motionCtx.globalAlpha = 0.16;
    for (let y = 2; y < h; y += spacing) {
      for (let x = 2; x < w; x += spacing) {
        motionCtx.fillRect(x, y, 1.5, 1.5);
      }
    }
    motionCtx.restore();

    // pixel position from normalized motion
    const margin = 4;
    const cx = w / 2;
    const cy = h / 2;
    const maxX = (w / 2) - margin;
    const maxY = (h / 2) - margin;

    const px = cx + motionNormX * maxX;
    const py = cy + motionNormY * maxY;

    // update trail
    trail.unshift({ x: px, y: py });
    if (trail.length > TRAIL_LENGTH) trail.pop();

    // draw trail squares with fading alpha
    for (let i = 0; i < trail.length; i++) {
      const t = trail[i];
      const alpha = 1 - i / TRAIL_LENGTH;
      const size = 5 - (i * 0.08); // slight shrink
      const half = size / 2;

      motionCtx.save();
      motionCtx.globalAlpha = 0.22 + alpha * 0.6;
      motionCtx.fillStyle = motionGraphColor;
      motionCtx.fillRect(t.x - half, t.y - half, size, size);
      motionCtx.restore();
    }
  }

  function renderLoop() {
    drawMotionGraph();
    requestAnimationFrame(renderLoop);
  }

  /* SPEAKER TAP TOGGLE --------------------------------------------------- */

  function toggleMotionGraph() {
    motionGraphEnabled = !motionGraphEnabled;
    if (motionGraphEnabled) {
      motionCanvas.classList.add("active");
    } else {
      motionCanvas.classList.remove("active");
      trail = [];
      motionCtx.clearRect(0, 0, graphWidth, graphHeight);
    }
  }

  speakerEl.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMotionGraph();
  });

  speakerEl.addEventListener("touchend", (e) => {
    e.preventDefault();
    e.stopPropagation();
    toggleMotionGraph();
  }, { passive: false });

  window.addEventListener("resize", resizeMotionCanvas);

  /* SENSOR PANEL --------------------------------------------------------- */

  sensorBtn.addEventListener("click", async () => {
    await Promise.allSettled([enableMotion(), enableAudio()]);
    sensorPanel.classList.add("hidden");
  });

  /* STARTUP INIT --------------------------------------------------------- */

  (function init() {
    try {
      const saved = localStorage.getItem("emojiBuddyColor");
      if (saved) gbEl.setAttribute("data-color", saved);
    } catch(_) {}

    applySize();
    updateMotionGraphColor();
    resizeMotionCanvas();

    // context-based emoji at startup (car likely at rest)
    const startEmoji = pickContextEmoji();
    currentEmoji = startEmoji;
    emojiEl.textContent = startEmoji;
    adjustVibeGauge(startEmoji);

    // boot sequence
    screenEl.classList.add("boot-off");
    screenEl.classList.add("boot-flash");

    setTimeout(() => {
      screenEl.classList.add("boot-on");
      screenEl.classList.remove("boot-off");

      setTimeout(() => {
        screenEl.classList.remove("boot-flash");
      }, 600);
    }, 260);

    renderLoop();
  })();

</script>

</body>
</html>
